name: Python package

on: [push]

jobs:
  ruff:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: 'src:'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install pip dependencies
        run: |
          cd python
          python -m pip install --upgrade pip
          pip install ruff
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Lint with ruff
        id: ruff
        run: |
          cd python
          ruff check src/*.py src/hardware/*.py src/game_board/*.py simulator/*.py
          echo "Ruff exits with $?" >> $GITHUB_STEP_SUMMARY

  mypy:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: 'src:'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install pip dependencies
        run: |
          cd python
          python -m pip install --upgrade pip
          pip install mypy pytest types-requests
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Check with mypy
        id: mypy
        run: |
          cd python
          mypy --config-file mypy.ini src/*.py src/hardware/*.py src/game_board/*.py simulator/*.py
          echo "mypy exits with $?" >> $GITHUB_STEP_SUMMARY

  pylint:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: 'src:'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install pip dependencies
        run: |
          cd python
          python -m pip install --upgrade pip
          pip install pylint
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Check with pylint
        id: pylint
        run: |
          cd python
          pylint src/*.py src/hardware/*.py simulator/*.py --exit-zero
          echo "pylint exits with $?" >> $GITHUB_STEP_SUMMARY

  test:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: 'src:'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install pip dependencies
        run: |
          cd python
          python -m pip install --upgrade pip
          pip install flake8 pytest
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Test with unittest
        id: unittest
        run: |
          cd python
          cp defaults/* work/
          python -m unittest discover -s test -p "test_*.py" -v

  coverage:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: 'src:'
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Install pip dependencies
        run: |
          cd python
          python -m pip install --upgrade pip
          pip install flake8 pytest coverage
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      - name: Run test coverage
        id: unittest
        run: |
          cd python
          cp defaults/* work/
          coverage run -m unittest discover
      - name: Coverage report
        id: report
        run: |
          cd python
          coverage report
